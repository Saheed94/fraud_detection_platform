name: CI Pipeline (Testing Branch)

on:
  push:
    branches:
      - testing

jobs:
  build-test:
    runs-on: ubuntu-latest
    env:
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}

      # These do NOT need to be secrets.
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      REDPANDA_BOOTSTRAP: redpanda:9092

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------
      # Start Docker Compose stack
      # --------------------------
      - name: Build and start Docker services
        run: docker compose up -d --build

      # --------------------------
      # Wait for Postgres to become healthy
      # --------------------------
      - name: Wait for Postgres
        run: |
          echo "Waiting for Postgres to be ready..."
          until docker exec fraud-platform-postgres pg_isready -U "$DB_USER"; do
            sleep 2
          done
          echo "Postgres is ready!"

      # --------------------------
      # Extra delay for the API to connect to DB
      # --------------------------
      - name: Wait for API startup
        run: sleep 8

      # --------------------------
      # Debug: show logs if API fails
      # --------------------------
      - name: Print API Logs (for debugging)
        run: docker logs fraud-platform-transaction-api-1

      # --------------------------
      # Test the API endpoint
      # --------------------------
      - name: Test /transactions endpoint
        run: |
          RESPONSE=$(curl -s http://localhost:8000/transactions)
          echo "API Response:"
          echo "$RESPONSE"

          if ! echo "$RESPONSE" | grep -q '"transactions"'; then
            echo "‚ùå API did not return transactions"
            exit 1
          fi

      # --------------------------
      # Shut down Docker stack
      # --------------------------
      - name: Stop all services
        if: always()
        run: docker compose down
