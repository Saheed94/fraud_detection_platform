name: CI - Docker Compose Fraud Platform

on:
  push:
    branches:
      - testing
  pull_request:
    branches:
      - testing

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      REDPANDA_BOOTSTRAP: redpanda:9092

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to DockerHub (optional)
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and start all services
        run: docker compose up -d --build

      - name: Wait for Postgres to be ready
        run: |
          echo "Waiting for Postgres..."
          until docker exec $(docker ps --format "{{.Names}}" | grep postgres | head -n 1) pg_isready -U "$DB_USER"; do
            sleep 2
          done
          echo "Postgres is ready!"

      - name: Sleep a few seconds for services to fully initialize
        run: sleep 8

      - name: Print transaction-api logs (auto-detect container)
        run: |
          API_CONTAINER=$(docker ps --format "{{.Names}}" | grep transaction-api | head -n 1)
          echo "API Container: $API_CONTAINER"
          docker logs "$API_CONTAINER"

      - name: Test /transactions endpoint
        run: |
          API_CONTAINER=$(docker ps --format "{{.Names}}" | grep transaction-api | head -n 1)
          RESPONSE=$(docker exec "$API_CONTAINER" curl -s http://localhost:8000/transactions)
          echo "$RESPONSE"
          if ! echo "$RESPONSE" | grep -q '"transactions"'; then
            echo "‚ùå API did not return transactions"
            exit 1
          fi

      - name: Tear down Docker Compose
        run: docker compose down
