name: CI - Fraud Platform Full Stack

on:
  push:
    branches: [testing]
  pull_request:
    branches: [testing]

jobs:
  full-stack-ci:
    runs-on: ubuntu-latest
    env:
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      REDPANDA_BOOTSTRAP: redpanda:9092

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and start all services
        run: docker compose up -d --build

      # -----------------------------
      # Wait for Postgres
      # -----------------------------
      - name: Wait for Postgres
        run: |
          echo "Waiting for Postgres..."
          until docker exec fraud-platform-postgres pg_isready -U "$DB_USER"; do
            sleep 2
          done
          echo "Postgres is ready!"

      # -----------------------------
      # Wait for Redpanda
      # -----------------------------
      - name: Wait for Redpanda
        run: |
          echo "Waiting for Redpanda..."
          until docker exec redpanda rpk topic list >/dev/null 2>&1; do
            sleep 2
          done
          echo "Redpanda is ready!"

      # -----------------------------
      # Wait for Redis
      # -----------------------------
      - name: Wait for Redis
        run: |
          echo "Waiting for Redis..."
          until docker exec fraud-platform-redis redis-cli ping | grep -q PONG; do
            sleep 2
          done
          echo "Redis is ready!"

      # -----------------------------
      # Wait for transaction-api
      # -----------------------------
      - name: Wait for Transaction API
        run: |
          echo "Waiting for transaction-api..."
          API_CONTAINER=$(docker ps --format "{{.Names}}" | grep transaction-api | head -n1)
          until docker exec $API_CONTAINER curl -s http://localhost:8000/transactions >/dev/null 2>&1; do
            sleep 2
          done
          echo "transaction-api is ready!"

      # -----------------------------
      # Run integration test: fetch transactions
      # -----------------------------
      - name: Test Transaction API
        run: |
          API_CONTAINER=$(docker ps --format "{{.Names}}" | grep transaction-api | head -n1)
          RESPONSE=$(docker exec "$API_CONTAINER" curl -s http://localhost:8000/transactions)
          echo "$RESPONSE"
          if ! echo "$RESPONSE" | grep -q '"transactions"'; then
            echo "❌ API did not return transactions"
            exit 1
          fi
          echo "✅ Transaction API returned data!"

      # -----------------------------
      # Tear down
      # -----------------------------
      - name: Shut down stack
        run: docker compose down
